name: Deploy to Hugging Face Spaces

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt


      - name: Install huggingface_hub
        run: |
          python -m pip install --upgrade pip
          pip install huggingface_hub

      - name: Create Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
              python -c "from huggingface_hub import HfApi, create_repo; import os; api = HfApi(); token = os.getenv('HF_TOKEN'); repo_id = '${{ github.repository }}';\
        try:\
          create_repo(repo_id=repo_id, token=token, repo_type='space', space_sdk='streamlit', exist_ok=True, private=False)\
          print('Space created or already exists')\
        except Exception as e:\
          print(f'Error creating space: {e}')"

      - name: Deploy to Hugging Face Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
              python -c "from huggingface_hub import HfApi; import os; api = HfApi(); repo_id = '${{ github.repository }}';\
        try:\
          api.upload_folder(folder_path='.', repo_id=repo_id, repo_type='space', token=os.getenv('HF_TOKEN'), ignore_patterns=['.git*', '__pycache__', '*.pyc', '.github/', 'data/'])\
          print('Successfully deployed to Hugging Face Spaces!')\
        except Exception as e:\
          print(f'Error during deployment: {e}')\
          exit(1)"
